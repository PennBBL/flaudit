---
title: 'FLAUDIT: Flywheel Project Audit'
output:
  html_document:
    df_print: paged
---

```{r, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=16, fig.height=12)
library(tidyverse)
library(knitr)
library(scales)
library(ggrepel)
library(wordcloud)
library(DT)
library(naniar)
library(gdata)
library(lubridate)
library(collapsibleTree)
```

```{r, include = FALSE, echo = FALSE}
attachments <- read_csv("data/attachments.csv") %>%
  filter(!str_detect(Type, "bvec|bval")) %>%
  filter(!(str_detect(Name, "json") & str_detect(Origin_Level, "Acquisition")))
seqinfo <- read_csv("data/seqinfo.csv") %>%
  filter(!is.na(series_description))
jobs <- read_csv("data/jobs.csv")
```

# Sequences

Here's a list of all the sequences in this project:

```{r, warning=FALSE, echo=FALSE}
sequences <- seqinfo %>%
  pull(protocol_name) %>% 
  table()  %>%
  as.data.frame() %>%
  arrange(-Freq)

wordcloud(sequences$., sequences$Freq, min.freq = 0, scale = c(1, 2), random.order = TRUE)
```

```{r, echo=FALSE}
datatable(sequences)
```

The tree diagram below shows how each sequence is curated into BIDS format. The leaf at the end of each branch counts how many individual files fall under each BIDS template.

```{r, echo = FALSE}
seqinfo %>%
  mutate(
    bids_name = str_replace_all(Filename, "sub-[^_]+(?=_)", "\\{subject\\}"),
    bids_name = str_replace_all(bids_name, "ses-[^_]+(?=_)", "\\{session\\}")
  ) %>%
  group_by(series_description, Folder, Modality, bids_name) %>%
  summarise(n = n()) %>%
  mutate(
    n = ifelse(is.na(Folder), 0, n),
    
  ) %>%
  collapsibleTreeSummary(., 
    c("series_description", "Folder", "Modality", "bids_name"),
    attribute = "n", root = 'project_label', width = 1000, height = 800, zoomable = TRUE
  )
```


Below, we visualise the missingness of sequences across all the subjects in the project:
```{r, echo=FALSE}
seq_ns <- unique(seqinfo$series_description)
ids <- unique(seqinfo$patient_id)
output_df <- data.frame(matrix(data = 0, ncol = length(seq_ns), nrow = length(ids)))

names(output_df) <- seq_ns

for(i in 1:length(ids)){
  
  df <- seqinfo %>%
    filter(patient_id == ids[i])
  
  for(row in 1:nrow(df)){
    
    
    target <- df$series_description[row]
    
    output_df[i, target] <- output_df[i, target] + 1
  }
  
}

output_df %>%
  mutate_all(.funs = function(x) ifelse(x == 0, NA, x)) %>%
  gg_miss_var(show_pct = TRUE) +
  labs(x = "Sequence") +
  theme_minimal(base_size = 18)
```

# Gears and Jobs

There have been `r length(unique(jobs$job_id))` gears run in total, for a total of `r as.character(lubridate::as.duration(sum(jobs$run_runtime_ms)/1000))`. The most commonly run gear is ``r jobs %>% group_by(gear_name) %>% summarise(n = n()) %>% arrange(-n) %>% pull(gear_name) %>% .[1]`` with a total of `r jobs %>% group_by(gear_name) %>% summarise(n = n()) %>% arrange(-n) %>% pull(n) %>% .[1]` runs. The gear with the most version increments is ``r jobs %>% group_by(gear_name) %>% summarise(n = n_distinct(gear_version)) %>% arrange(-n) %>% pull(gear_name) %>% .[1]``.

Here are the gear completion statistics:

```{r, echo=FALSE}
jobs_plot <- jobs %>%
  # mutate(run_status = factor(run_status)) %>%
  group_by(job_id) %>%
  arrange(run_status) %>%
  filter(row_number() == 1) %>%
  group_by(gear_name, run_status) %>%
  summarise(n = n()) %>%
  mutate(freq = n / sum(n),
         perc = percent(freq, accuracy = 1),
         cumsum = cumsum(n)) %>%
  ungroup() %>%
  # mutate(perc = ifelse(freq < 0.2, "", perc)) %>%
  ggplot(aes(x=gear_name, y=n, group = run_status)) +
    geom_bar(aes(fill=run_status), stat = 'identity', position = "dodge") +
    theme_minimal(base_size = 18) +
    scale_fill_viridis_d() +
    geom_label_repel(aes(label = perc, y=n), force = 5, position = position_dodge(0.5)) +
    coord_flip() +
    labs(title = "Gear Runs & Completion Rate", x = "Gear Label") +
    NULL
    
jobs_plot
```

# Gear Runtime

Below are the runtimes of gear runs:

```{r, echo=FALSE}
jobs %>%
  mutate(run_runtime_ms = run_runtime_ms/1000/60) %>%
  #group_by(gear_name) %>%
  ggplot(aes(x=run_runtime_ms)) +
    geom_histogram(aes(fill = run_status), alpha = 0.5, bins = 25) +
    theme_minimal(base_size = 18) +
    scale_fill_viridis_d() +
    labs(title = "Gear Runtimes", x = "Runtime in Minutes") +
    facet_wrap(~gear_name, scales = "free")
```

# Attachments

There are `r nrow(attachments)` attachments for a total of `r humanReadable(sum(attachments$Size_kb), width=4, standard = "SI")` of data. 
```{r, echo=FALSE}
attachments %>%
  ggplot(aes(x=Type)) +
  geom_bar(aes(fill = Origin_Level), alpha = 0.5) +
  theme_minimal(base_size = 18) +
  scale_fill_viridis_d() +
  labs(title = "Attachments Count")# +
  #facet_wrap(~gear_name, scales = "free")
```

